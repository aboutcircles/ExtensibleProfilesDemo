<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Circles Marketplace Viewer</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif; margin: 0; padding: 0; background: #fafafa; color: #222; }
    header { background: #2f3d4a; color: white; padding: 12px 16px; }
    main { padding: 16px; max-width: 1000px; margin: 0 auto; }
    .panel { background: white; border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin-bottom: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    label { display: inline-block; font-size: 12px; color: #444; margin-bottom: 4px; }
    input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
    input[type="text"] { width: 320px; max-width: 100%; }
    button { padding: 8px 14px; background: #2f7ae5; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:disabled { opacity: .6; cursor: default; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; }
    .card { background: white; border: 1px solid #e2e2e2; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
    .thumb { width: 100%; height: 180px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; color: #888; font-size: 12px; object-fit: cover; }
    .card-body { padding: 10px 12px; display: flex; flex-direction: column; gap: 6px; }
    .muted { color: #666; font-size: 12px; }
    .error { color: #b00020; white-space: pre-wrap; }
    .small { font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    footer { text-align: center; color: #777; padding: 20px; font-size: 12px; }
    .inline { display:inline-block; }
  </style>
</head>
<body>
  <header>
    <h1 class="small">Circles Profile Market Viewer</h1>
  </header>
  <main>
    <section class="panel">
      <div class="row">
        <div>
          <label for="op">Namespace address</label><br />
          <input id="op" type="text" placeholder="0x..." />
        </div>
        <div>
          <label for="avatars">Avatars (space/comma separated)</label><br />
          <input id="avatars" type="text" placeholder="0xAlice 0xBob" />
        </div>
        <div>
          <label for="chainId">Chain ID</label><br />
          <input id="chainId" type="number" value="100" min="1" />
        </div>
        <div>
          <label for="start">Window start (local)</label><br />
          <input id="start" type="datetime-local" />
        </div>
        <div>
          <label for="end">Window end (local)</label><br />
          <input id="end" type="datetime-local" />
        </div>
        <div>
          <label for="pageSize">Page size</label><br />
          <input id="pageSize" type="number" value="20" min="1" max="100" />
        </div>
        <div>
          <label for="apiBase">API base</label><br />
          <input id="apiBase" type="text" placeholder="http://localhost:5084" value="http://localhost:5084" />
        </div>
        <div style="align-self: end; padding-bottom: 2px; display:flex; gap:8px;">
          <button id="loadBtn">Load</button>
          <button id="prevBtn" disabled>Prev</button>
          <button id="nextBtn" disabled>Next</button>
        </div>
      </div>
      <div id="status" class="muted" style="margin-top: 8px;"></div>
      <div id="error" class="error" style="margin-top: 8px;"></div>
    </section>

    <section class="panel">
      <div class="row" style="justify-content: space-between;">
        <div>
          <strong>Products</strong> <span id="count" class="muted"></span>
          <span id="avatarsScanned" class="muted small"></span>
        </div>
        <div class="muted small"><span id="pageInfo"></span> One offer per product (first offer shown)</div>
      </div>
      <div id="results" class="grid" style="margin-top: 12px;"></div>
    </section>

    <details class="panel">
      <summary class="small">Help</summary>
      <div class="small" style="margin-top:8px;">
        • This viewer uses the Market API endpoint <span class="mono">/api/operator/{op}/catalog</span> to aggregate products across avatars.<br />
        • Required query: at least one <span class="mono">avatars=0x…</span>. Optional: <span class="mono">chainId</span>, <span class="mono">start</span>, <span class="mono">end</span>, <span class="mono">pageSize</span>.<br />
        • Pagination: the server returns a <span class="mono">X-Next-Cursor</span> header and Link rel="next". Use Next/Prev to navigate pages.<br />
        • API base can be left empty to call the same origin, or set to your server, e.g. <span class="mono">http://localhost:5084</span>.<br />
        • Raw JSON links open the product CID on a public IPFS gateway.
      </div>
    </details>
  </main>
  <footer>
    Static viewer bundled with Circles.Profiles.Tool — no wallet or signer needed.
  </footer>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const opInput = $('#op');
  const avatarsInput = $('#avatars');
  const chainIdInput = $('#chainId');
  const startInput = $('#start');
  const endInput = $('#end');
  const pageSizeInput = $('#pageSize');
  const apiBaseInput = $('#apiBase');

  const statusEl = $('#status');
  const errorEl = $('#error');
  const resultsEl = $('#results');
  const countEl = $('#count');
  const avatarsScannedEl = $('#avatarsScanned');
  const pageInfoEl = $('#pageInfo');

  const loadBtn = $('#loadBtn');
  const prevBtn = $('#prevBtn');
  const nextBtn = $('#nextBtn');

  const state = { cursor: null, nextCursor: null, prevCursors: [] };

  function setStatus(msg) { statusEl.textContent = msg || ''; }
  function setError(msg) { errorEl.textContent = msg || ''; }

  function parseAvatars(s) { return (s || '').split(/[\s,]+/).map(a => a.trim()).filter(Boolean); }

  function toUnixSeconds(dt) {
    if (!dt) return null;
    const ms = Date.parse(dt);
    if (Number.isNaN(ms)) return null;
    return Math.floor(ms / 1000);
  }

  function buildUrl() {
    const baseRaw = apiBaseInput.value.trim();
    let base = baseRaw ? baseRaw.replace(/\/$/, '') : '';
    const op = (opInput.value || '').trim();

    const q = new URLSearchParams();
    const avatars = parseAvatars(avatarsInput.value);
    for (const a of avatars) q.append('avatars', a);

    const chainId = parseInt(chainIdInput.value, 10);
    if (!Number.isNaN(chainId)) q.set('chainId', String(chainId));

    const startSec = toUnixSeconds(startInput.value);
    const endSec = toUnixSeconds(endInput.value);
    if (startSec != null) q.set('start', String(startSec));
    if (endSec != null) q.set('end', String(endSec));

    const pageSize = parseInt(pageSizeInput.value, 10);
    if (!Number.isNaN(pageSize)) q.set('pageSize', String(pageSize));

    if (state.cursor) q.set('cursor', state.cursor);

    const path = `/api/operator/${encodeURIComponent(op)}/catalog`;

    // If opened from non-HTTP(S) origins (e.g., file://), avoid relative URLs that become file:///...
    const isHttpOrigin = location.protocol === 'http:' || location.protocol === 'https:';
    if (!isHttpOrigin && !base) {
      base = 'http://localhost:5084';
    }

    const url = (base ? base + path : path) + '?' + q.toString();
    return url;
  }

  function pickImageUrl(product) {
    const imgs = product?.image || [];
    if (!Array.isArray(imgs)) return null;
    for (const it of imgs) {
      if (!it) continue;
      if (typeof it === 'string') return it;
      if (typeof it?.url === 'string') return it.url;
      if (typeof it?.Url === 'string') return it.Url;
      if (typeof it?.object?.contentUrl === 'string') return it.object.contentUrl;
      if (typeof it?.Object?.ContentUrl === 'string') return it.Object.ContentUrl;
    }
    return null;
  }

  function shortAddr(a) {
    if (!a) return '';
    return a.slice(0, 6) + '…' + a.slice(-4);
  }

  function renderPage(body) {
    const items = Array.isArray(body?.products) ? body.products : [];

    resultsEl.innerHTML = '';
    countEl.textContent = items.length ? `(${items.length})` : '';

    const scanned = Array.isArray(body?.avatarsScanned) ? body.avatarsScanned : [];
    avatarsScannedEl.textContent = scanned.length ? `from ${scanned.length} avatar(s)` : '';

    for (const p of items) {
      const product = p.product || {};
      const offer = Array.isArray(product?.offers) ? (product.offers[0] || null) : (product?.offers || null);

      const card = document.createElement('div');
      card.className = 'card';

      const imgUrl = pickImageUrl(product) || product?.imageUrl || product?.ImageUrl || null;
      const thumb = document.createElement(imgUrl ? 'img' : 'div');
      thumb.className = 'thumb';
      if (imgUrl) {
        thumb.src = imgUrl;
        thumb.loading = 'lazy';
        thumb.alt = product?.name || product?.Name || 'product-image';
      } else {
        thumb.textContent = 'No image';
      }

      const bodyEl = document.createElement('div');
      bodyEl.className = 'card-body';

      const name = product?.name || product?.Name || '(no name)';
      const h = document.createElement('div');
      h.textContent = name;
      h.style.fontWeight = '600';
      bodyEl.appendChild(h);

      if (product?.description || product?.Description) {
        const d = document.createElement('div');
        d.className = 'muted small';
        d.textContent = product.description || product.Description;
        bodyEl.appendChild(d);
      }

      if (offer) {
        const price = offer.price ?? offer.Price;
        const curr = offer.priceCurrency || offer.PriceCurrency;
        const avail = offer.availability || offer.Availability;
        const availText = typeof avail === 'string' ? avail : (avail?.name || avail?.Name || '');
        const o = document.createElement('div');
        o.className = 'small';
        o.textContent = `Offer: ${price ?? '?'} ${curr ?? ''} ${availText ? '(' + availText + ')' : ''}`;
        bodyEl.appendChild(o);
      }

      const meta = document.createElement('div');
      meta.className = 'muted small';
      const ts = typeof p.publishedAt === 'number' ? new Date(p.publishedAt * 1000) : null;
      const tsText = ts ? ts.toISOString() : '';
      meta.textContent = `${shortAddr(p.seller || '')}${tsText ? ' · ' + tsText : ''}`;
      bodyEl.appendChild(meta);

      const links = document.createElement('div');
      links.className = 'row';
      links.style.justifyContent = 'space-between';

      const left = document.createElement('div');
      left.className = 'inline';
      if (offer) {
        const checkout = offer.checkout || offer.Checkout;
        if (typeof checkout === 'string' && checkout.trim() !== '') {
          const buyBtn = document.createElement('button');
          buyBtn.textContent = 'Buy';
          buyBtn.title = 'Open checkout';
          buyBtn.addEventListener('click', (ev) => {
            ev.preventDefault();
            try { window.open(checkout, '_blank', 'noopener'); } catch { location.href = checkout; }
          });
          left.appendChild(buyBtn);
        }
      }
      links.appendChild(left);

      const right = document.createElement('div');
      right.className = 'inline';

      if (product?.url || product?.Url) {
        const a = document.createElement('a');
        a.href = product.url || product.Url;
        a.target = '_blank';
        a.rel = 'noopener';
        a.className = 'small inline';
        a.textContent = 'Open product page';
        right.appendChild(a);
        const sep = document.createElement('span'); sep.textContent = ' \u00A0·\u00A0 '; right.appendChild(sep);
      }

      if (p.productCid) {
        const raw = document.createElement('a');
        raw.href = 'https://ipfs.io/ipfs/' + encodeURIComponent(p.productCid);
        raw.target = '_blank';
        raw.rel = 'noopener';
        raw.className = 'small inline';
        raw.textContent = 'Raw JSON';
        right.appendChild(raw);
      }

      links.appendChild(right);

      bodyEl.appendChild(links);
      card.appendChild(thumb);
      card.appendChild(bodyEl);
      resultsEl.appendChild(card);
    }

    if (Array.isArray(body?.errors) && body.errors.length) {
      setError(body.errors.map(e => JSON.stringify(e)).join('\n'));
    }
  }

  async function fetchAndRender() {
    setError('');
    setStatus('Loading...');
    resultsEl.innerHTML = '';
    countEl.textContent = '';
    avatarsScannedEl.textContent = '';
    pageInfoEl.textContent = '';
    nextBtn.disabled = true;

    const avatars = parseAvatars(avatarsInput.value);
    if (!avatars.length) { setError('Please enter at least one avatar'); setStatus(''); return; }
    const op = opInput.value.trim();
    if (!op) { setError('Please enter namespace address'); setStatus(''); return; }

    const url = buildUrl();
    try {
      const res = await fetch(url, { headers: { 'Accept': 'application/ld+json' } });
      if (!res.ok) {
        const text = await res.text().catch(() => '');
        throw new Error(`Request failed: ${res.status} ${res.statusText}${text ? ' — ' + text : ''}`);
      }
      state.nextCursor = res.headers.get('X-Next-Cursor');
      nextBtn.disabled = !state.nextCursor;
      const body = await res.json();
      renderPage(body);
      const pageNum = state.prevCursors.length + 1;
      pageInfoEl.textContent = `(page ${pageNum}${state.nextCursor ? '' : ' — last'})`;
      setStatus(`Loaded ${Array.isArray(body?.products) ? body.products.length : 0} item(s).`);
    } catch (err) {
      console.error(err);
      setError(String(err?.message || err));
      setStatus('');
    }
    prevBtn.disabled = state.prevCursors.length === 0;
  }

  function updateUrlQuery() {
    const q = new URLSearchParams();
    const op = opInput.value.trim();
    if (op) q.set('op', op);
    const avs = parseAvatars(avatarsInput.value);
    for (const a of avs) q.append('avatars', a);
    const chainId = chainIdInput.value.trim();
    if (chainId) q.set('chainId', chainId);
    if (startInput.value) q.set('start', String(toUnixSeconds(startInput.value)));
    if (endInput.value) q.set('end', String(toUnixSeconds(endInput.value)));
    const size = pageSizeInput.value.trim();
    if (size) q.set('pageSize', size);
    const api = apiBaseInput.value.trim();
    if (api) q.set('api', api);
    if (state.cursor) q.set('cursor', state.cursor);
    const newUrl = location.pathname + '?' + q.toString();
    history.replaceState(null, '', newUrl);
  }

  async function onLoadClick() {
    state.prevCursors = [];
    state.cursor = null;
    updateUrlQuery();
    prevBtn.disabled = true;
    await fetchAndRender();
  }

  async function onNext() {
    if (!state.nextCursor) return;
    state.prevCursors.push(state.cursor);
    state.cursor = state.nextCursor;
    updateUrlQuery();
    await fetchAndRender();
  }

  async function onPrev() {
    if (!state.prevCursors.length) return;
    state.cursor = state.prevCursors.pop() || null;
    updateUrlQuery();
    await fetchAndRender();
  }

  loadBtn.addEventListener('click', () => { loadBtn.disabled = true; onLoadClick().finally(() => loadBtn.disabled = false); });
  nextBtn.addEventListener('click', () => { nextBtn.disabled = true; onNext().finally(() => nextBtn.disabled = false); });
  prevBtn.addEventListener('click', () => { prevBtn.disabled = true; onPrev().finally(() => prevBtn.disabled = false); });

  const params = new URLSearchParams(location.search);
  const urlOp = params.get('op');
  const urlAvatars = params.getAll('avatars');
  const urlChain = params.get('chainId');
  const urlStart = params.get('start');
  const urlEnd = params.get('end');
  const urlSize = params.get('pageSize') || params.get('limit');
  const urlApi = params.get('api') || params.get('apiBase');
  const urlCursor = params.get('cursor');

  if (urlOp) opInput.value = urlOp;
  if (urlAvatars && urlAvatars.length) avatarsInput.value = urlAvatars.join(' ');
  if (urlChain) chainIdInput.value = urlChain;
  if (urlStart) {
    const s = new Date(parseInt(urlStart, 10) * 1000);
    if (!isNaN(s)) startInput.value = s.toISOString().slice(0, 16);
  }
  if (urlEnd) {
    const e = new Date(parseInt(urlEnd, 10) * 1000);
    if (!isNaN(e)) endInput.value = e.toISOString().slice(0, 16);
  }
  if (urlSize) pageSizeInput.value = urlSize;
  if (urlApi) apiBaseInput.value = urlApi;
  if (urlCursor) state.cursor = urlCursor;

  if (opInput.value && avatarsInput.value) {
    setTimeout(() => loadBtn.click(), 50);
  }
})();
</script>
</body>
</html>
